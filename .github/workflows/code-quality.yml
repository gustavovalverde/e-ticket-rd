name: Code Quality & Linting

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    name: Quality Checks & Linting
    permissions:
      contents: read
      checks: write
      pull-requests: write
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check types
        run: npm run type-check

      - name: Lint code
        run: npm run lint:strict

      - name: Check formatting
        run: npm run format:check

      - name: Audit security
        run: npm audit --audit-level=moderate

  super-linter:
    runs-on: ubuntu-latest
    name: Multi-language Linting
    permissions:
      contents: read
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Lint files
        uses: super-linter/super-linter@12150456a73e248bdc94d0794898f94e23127c88 # v7.4.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_TYPESCRIPT_ES: false
          VALIDATE_JAVASCRIPT_ES: false
          VALIDATE_ESLINT: false
          VALIDATE_PRETTIER: false

  quality-gate:
    runs-on: ubuntu-latest
    name: Quality Gate
    needs: [quality-checks, super-linter]
    permissions:
      contents: read
      pull-requests: write # Allow PR comments

    steps:
      - name: Report results
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { context } = require('@actions/github');

            // Create workflow summary (visible in Actions tab)
            await core.summary
              .addHeading('ğŸ‰ All Quality Checks Passed', 2)
              .addList([
                'âœ… TypeScript types look good',
                'âœ… ESLint found no security or accessibility issues',
                'âœ… Code formatting matches project style',
                'âœ… No security vulnerabilities found',
                'âœ… All file formats checked'
              ])
              .addQuote('ğŸš€ Ready for the Dominican Republic E-Ticket system!')
              .write();

            // Add PR comment for pull requests
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: '## âœ… All Quality Checks Passed\\n\\n**Everything looks good:**\\n- ğŸ” TypeScript types are clean\\n- ğŸ›¡ï¸ No security or accessibility issues found\\n- ğŸ¨ Code formatting matches our style\\n- ğŸ”’ No security vulnerabilities detected\\n- ğŸ“ All file formats checked\\n\\n*Ready for review and merge!* ğŸš€'
              });
            }

            core.info('ğŸ‰ Quality checks all passed!');
